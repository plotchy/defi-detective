[{"SourceCode":"pragma solidity ^0.8.0;\r\n\r\nabstract contract ERC20 {\r\n    function balanceOf(address who) public virtual view returns (uint256);\r\n    function transfer(address to, uint256 value) public virtual returns (bool);\r\n    function transferFrom(address from, address to, uint256 value) public virtual returns (bool);\r\n}\r\n\r\ncontract uDistributeV2 {\r\n\r\n   struct distribution{\r\n        uint tokenIndex;        //token Index\r\n        uint recipientIndex;      //recipient\r\n        uint p;                 //period\r\n        uint a;                 //amount per period\r\n        uint touchpoint;        //Withdrawal touch point, when the initial waiting period has ended, or the last withdrawal has occured\r\n        uint totalAmount;       //totalAmount Distributed\r\n    }\r\n\r\n    event Distribution(address token,address distributor,address recipient,uint256 index,uint256 amount,string description);\r\n\tevent Withdrawal(address token,address recipient,uint256 index,uint256 amount);\r\n\r\n    mapping(uint => distribution[]) public distributions;\r\n\r\n    mapping(address => uint) public recipientIndexes;\r\n    address[] public recipientList;\r\n\r\n    mapping(address => uint) public tokenIndexes;\r\n    address[] public tokenList;\r\n\r\n    constructor() {\r\n        tokenList.push(address(0));\r\n        tokenIndexes[0x92e52a1A235d9A103D970901066CE910AAceFD37] = 1;\r\n        tokenList.push(0x92e52a1A235d9A103D970901066CE910AAceFD37);\r\n        recipientList.push(address(0));\r\n    }\r\n\r\n    function distribute(address token, address recipient,uint waitTime, uint period, uint amountPerPeriod, uint amount, string memory description) public{\r\n        ERC20(token).transferFrom(msg.sender,address(this),amount);\r\n\r\n        uint touchPoint = block.timestamp + waitTime;\r\n\r\n        uint rIndex = _getRecipientIndex(recipient);\r\n\r\n        emit Distribution(token,msg.sender,recipient,numDistributions(recipient),amount,description);\r\n\r\n        distributions[rIndex].push(distribution(\r\n            getTokenIndex(token),\r\n            rIndex,\r\n            period,\r\n            amountPerPeriod,\r\n            touchPoint,\r\n            amount)\r\n        );\r\n    }\r\n\r\n    function withdraw(uint index) public {\r\n        distribution memory d = distributions[getRecipientIndex(msg.sender)][index];\r\n        require(index<numDistributions(msg.sender), \"Requested distribution does not exist\");\r\n        uint toWithdraw = getWithdrawable(msg.sender,index);\r\n        require(block.timestamp>=d.touchpoint, \"waiting period is not over yet\");\r\n        require(toWithdraw>0,\"Nothing to Withdraw\");\r\n\r\n        ERC20(tokenList[d.tokenIndex]).transfer(msg.sender,toWithdraw);\r\n\r\n        distributions[getRecipientIndex(msg.sender)][index].touchpoint = block.timestamp;\r\n        distributions[getRecipientIndex(msg.sender)][index].totalAmount -= toWithdraw;\r\n\r\n        emit Withdrawal(tokenList[d.tokenIndex],msg.sender,index,toWithdraw);\r\n    }\r\n\r\n    function getWithdrawable(address recipient,uint index) public view returns (uint){\r\n        distribution memory d = distributions[getRecipientIndex(recipient)][index];\r\n        uint toWithdraw;\r\n        uint elapsedPeriods;\r\n\r\n        if(block.timestamp<d.touchpoint){\r\n            return(0);\r\n        }\r\n\r\n        elapsedPeriods = (block.timestamp - d.touchpoint)/d.p;\r\n\r\n        if(elapsedPeriods<=0){\r\n            return(0);\r\n        }\r\n\r\n        toWithdraw = d.a*elapsedPeriods;\r\n\r\n        if(toWithdraw>d.totalAmount){\r\n            return(d.totalAmount);\r\n        }\r\n\r\n        return(toWithdraw);\r\n    }\r\n\r\n    function getRecipientIndex(address recipient) public view returns(uint){\r\n        return(recipientIndexes[recipient]);\r\n    }\r\n\r\n    function _getRecipientIndex(address recipient) internal returns(uint){\r\n        if (recipientIndexes[recipient]==0){\r\n            recipientIndexes[recipient]= recipientList.length;\r\n            recipientList.push(recipient);\r\n        }\r\n        return(recipientIndexes[recipient]);\r\n    }\r\n\r\n    function getTokenIndex(address token) internal returns(uint){\r\n        if (tokenIndexes[token]==0){\r\n            tokenList.push(token);\r\n            tokenIndexes[token]= tokenList.length;\r\n        }\r\n        return(tokenIndexes[token]);\r\n    }\r\n\r\n    function numDistributions(address recipient) public view returns(uint) {\r\n        return distributions[getRecipientIndex(recipient)].length;\r\n    }\r\n}","ABI":"[{\"inputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"token\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"distributor\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"index\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"string\",\"name\":\"description\",\"type\":\"string\"}],\"name\":\"Distribution\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"address\",\"name\":\"token\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"index\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"Withdrawal\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"token\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"waitTime\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"period\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"amountPerPeriod\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"},{\"internalType\":\"string\",\"name\":\"description\",\"type\":\"string\"}],\"name\":\"distribute\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"distributions\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenIndex\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"recipientIndex\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"p\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"a\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"touchpoint\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"totalAmount\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"}],\"name\":\"getRecipientIndex\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"index\",\"type\":\"uint256\"}],\"name\":\"getWithdrawable\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"recipient\",\"type\":\"address\"}],\"name\":\"numDistributions\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"recipientIndexes\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"recipientList\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"tokenIndexes\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"tokenList\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"index\",\"type\":\"uint256\"}],\"name\":\"withdraw\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}]","ContractName":"uDistributeV2","CompilerVersion":"v0.8.1+commit.df193b15","OptimizationUsed":"0","Runs":"200","ConstructorArguments":"","EVMVersion":"Default","Library":"","LicenseType":"None","Proxy":"0","Implementation":"","SwarmSource":"ipfs://1bc2fcb0f451be85ed5504aaaec1500083ee6c83bd7b2beacab9349d1c8be02d"}]